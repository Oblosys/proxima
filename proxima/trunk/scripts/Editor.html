<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- v1 -->
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>Proxima 2.0</title>


<!-- <meta http-equiv="content-type" content="text/xhtml; charset=ISO-8859-1"/> -->

<script type="text/javascript">
<![CDATA[
var xmlhttp;
function loadXMLDoc(url)
{

xmlhttp=null;
if (window.XMLHttpRequest)
  {// code for Firefox, Opera, IE7, etc.
  xmlhttp=new XMLHttpRequest();
  }
else if (window.ActiveXObject)
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
if (xmlhttp!=null)
  {
  xmlhttp.onreadystatechange=state_Change;
  xmlhttp.open("GET",url,true);
  xmlhttp.send(null);
  }
else
  {
  alert("Your browser does not support XMLHTTP.");
  }
}

function state_Change()
{
if (xmlhttp.readyState==4)
  {// 4 = "loaded"
  if (xmlhttp.status==200)
    {// 200 = "OK"
    
    
    var newRendering = document.getElementById('newRendering');
    newRendering.innerHTML=xmlhttp.responseText;
    
    var focus = document.getElementById('focus');
    
    
    var updates = document.getElementById('updates');
    // getElementById seems to trigger parsing the responseText
    // after this, firstChild has a value, while it is null before
                // newRendering.firstChild;
    
    
 //   updateTree( updates.firstChild );
    while (updates.firstChild)
    { updateTree( updates.firstChild );
    ; updates.removeChild(updates.firstChild);
    }
    
    //var renderArea = document.getElementById('renderArea');
    //renderArea.removeChild( document.getElementById('root') ); //old rendering

    //var xmlRoot = xmlhttp.responseXML.firstChild;
    
    
    //renderingRoot = document.getElementById('root');
    //newRendering.removeChild( renderingRoot );
    
    //renderArea.appendChild( renderingRoot );
    
    //while (renderArea.firstChild) {
    //  renderArea.removeChild(renderArea.firstChild);
    //}
    //
    // getElementById does not seem to work for dynamically added XML nodes.
    

    
    //var status = xmlRoot.getAttribute("status");
    //if (status !='')
    //  document.getElementById('status').innerHTML = status;
    }
  else
    {
    debug("Problem retrieving data:" + xmlhttp.statusText);
    document.getElementById('renderArea').innerHTML='Server not available.';
    }
  }
}

function updateTree(update)
{ var op = update.getAttribute('op');
 /*
  if (op === 'add')
  { var parentId = update.getAttribute('parentId');
    var newChild = update.firstChild;
    var parent = document.getElementById(parentId);
    parent.appendChild( newChild );
    debug('add to '+parentId+' '+newChild.getAttribute('Id'));
  }    
  else if (op === 'remove')
  { var parentId = update.getAttribute('parentId');
    var targetId = update.getAttribute('targetId');
    var parent = document.getElementById(parentId);
    if (parent==null)
    { debug('parent '+parentId+' is null');
      return;
    }
    
    var target = document.getElementById(targetId);
    parent.removeChild( target );
    debug('remove '+targetId+' from '+parentId);
  } 
  else 
  */
  if (op === 'replace')
  { var path = update.childNodes[0];
    var newChild = update.childNodes[1];
    
    var oldChild = select(path, document.getElementById('proxima'));
    
    var parent = oldChild.parentNode;
    
    parent.replaceChild(newChild,oldChild);
      
//    debug('replace '+targetId+' at '+parentId+' by '+newChild.getAttribute('Id'));
  } 

}

function select(path, node)
{ var step = path.firstChild;
  if (!step)
    return node;
  else
    { path.removeChild(step);
      var childNr = parseInt( step.getAttribute('childNr') ); 
      var child = node.childNodes[childNr];
      return (select (path, child));
    }
}

function debug(message)
{
    document.getElementById('debugMessage').innerHTML=message;
}
var shiftDown = false;
var ctrlDown = false;
var altDown = false;

function init()
{
    
    if (document.addEventListener)
    {
       document.addEventListener("keydown",keydown,false);
       document.addEventListener("keyup",keyup,false);
       document.addEventListener("keypress",keypress,false);
    }
    else if (document.attachEvent) // IE7
    {
       document.attachEvent("onkeydown", keydown);
       document.attachEvent("onkeyup", keyup);
       document.attachEvent("onkeypress", keypress);
    }
    else
    {
       document.onkeydown= keydown;
       document.onkeyup= keyup;
       document.onkeypress= keypress;
    }
//    setRefreshTimer(10);

    refresh();
    loadXMLDoc('Key116?'); // put this one in refresh?
}

/*
function setRefreshTimer(ms)
{  
    setTimeout('refresh()',ms);
}

function refresh()
{
    loadXMLDoc('SpecialRefresh?');
    setRefreshTimer(200);
}
*/

function refresh()
{ removeChildren('rendering');
  removeChildren('focus');
  removeChildren('newRendering');
}

function removeChildren(parentId)
{ var parent = document.getElementById(parentId);
    while (parent.firstChild)
      parent.removeChild(parent.firstChild);
}

function keypress(e)
{
   if (!e) e= event;

   var keyCode =  (e.keyCode != 0) ? e.keyCode : e.charCode
   // keyCode is 0 on Firefox
   
//   debug('Key is '+keyCode +',' + e.charCode);
//   loadXMLDoc('Chr'+String.fromCharCode(keyCode)+'?');
   if (e.which != 0 && keyCode != 8 && keyCode != 13) 
     loadXMLDoc('Chr'+keyCode+'?');
// ? is to prevent caching by IE 
// maybe also check alt, ctrl and  other keys, they seem to generate press events now
   
   if (e.preventDefault) e.preventDefault();
   if (e.stopPropagation) e.stopPropagation();

   return false;
}

function hasNoKeyPress(keyCode)
{
   return keyCode == 13 || keyCode == 8 || keyCode == 46 ||
          keyCode >= 37 && keyCode <= 40||
          keyCode >= 112 && keyCode <= 123;

}

function recordModifiersDown( keyCode )
{
  if (keyCode == 16) shiftDown = true;
  else if (keyCode == 17) ctrlDown = true;
  else if (keyCode == 18) altDown = true;
  debug(shiftDown+' '+ctrlDown+' '+altDown);
}

function recordModifiersUp( keyCode )
{
  if (keyCode == 16) shiftDown = false;
  else if (keyCode == 17) ctrlDown = false;
  else if (keyCode == 18) altDown = false;
  debug(shiftDown+' '+ctrlDown+' '+altDown);
}

function keydown(e)
{
   if (!e) e = event;
   if (e.keyCode==116)
     refresh();
   recordModifiersDown(e.keyCode);
   
   if (hasNoKeyPress(e.keyCode) || e.ctrlKey || e.altKey || e.metaKey)
   {
     loadXMLDoc('Key'+e.keyCode+'?');
     if (e.preventDefault) e.preventDefault();
     if (e.stopPropagation) e.stopPropagation();
     return false; // false, so no keyPress event is generated
   }
   return true;
}
/* for preventing default behavior: (unclear whether or how this works)     
     if (e.preventDefault) e.preventDefault();
     if (e.stopPropagation) e.stopPropagation();
*/

function keyup(e)
{
   if (!e) e = event;
   recordModifiersUp(e.keyCode);
}

function ignore(e)
{
   if (e.preventDefault) e.preventDefault();
   if (e.stopPropagation) e.stopPropagation();

   return false;
}


function mouseHandler(str,e) 
{
	var posx = 0;
	var posy = 0;



        if(e.offsetX && e.offsetY) // IE
        {
//                e = window.event;
                posx = e.offsetX;
                posy = e.offsetY;
        }
        else       // we assume DOM modeled javascript
        {
                var Element = e.target ;
                var CalculatedTotalOffsetLeft = 0;
                var CalculatedTotalOffsetTop = 0 ;

                while (Element.offsetParent)
                {
                        CalculatedTotalOffsetLeft += Element.offsetLeft ;     
                        CalculatedTotalOffsetTop += Element.offsetTop ;
                        Element = Element.offsetParent ;
                }

                posx = e.pageX - CalculatedTotalOffsetLeft ;
                posy = e.pageY - CalculatedTotalOffsetTop ;
        }



/*
	if (!e) var e = window.event;
	
	//debug('Target: '+e.target.id);
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}
*/
  var proxima = document.getElementById('proxima');
    
  posx = posx + proxima.scrollLeft;
  posy = posy + proxima.scrollTop; 

	
	debug('Mouse:'+posx+','+posy);
	// posx and posy contain the mouse position relative to the document
	// Do something with this information

  //var renderAreaRect = document.getElementById('renderArea').getBoundingClientRect();
  //loadXMLDoc('Mouse' + str + '(' + (posx - renderAreaRect.left ) + ',' +
  //                                 (posy - renderAreaRect.top)  + ')?' );
  loadXMLDoc('Mouse' + str + '(' + (posx) + ',' +
                                   (posy) + ',' +
                                   (shiftDown?'True':'False') + ',' +
                                   (ctrlDown?'True':'False') + ',' +
                                   (altDown?'True':'False') + ')?' );
}



function getMouseCoordsWithinEventTarget(event)
{
        var coords = { x: 0, y: 0};

        if(!event) // then we have a non-DOM (probably IE) browser
        {
                event = window.event;
                coords.x = event.offsetX;
                coords.y = event.offsetY;
        }
        else       // we assume DOM modeled javascript
        {
                var Element = event.target ;
                var CalculatedTotalOffsetLeft = 0;
                var CalculatedTotalOffsetTop = 0 ;

                while (Element.offsetParent)
                {
                        CalculatedTotalOffsetLeft += Element.offsetLeft ;     
                        CalculatedTotalOffsetTop += Element.offsetTop ;
                        Element = Element.offsetParent ;
                }

                coords.x = event.pageX - CalculatedTotalOffsetLeft ;
                coords.y = event.pageY - CalculatedTotalOffsetTop ;
        }

        return coords;
}


function scrollHandler(event)
{
    var proxima = document.getElementById('proxima');
    
//    debug('scroll '+ proxima.scrollLeft + ',' +proxima.scrollTop); 
    loadXMLDoc('SpecialScroll((' + proxima.scrollLeft + ',' + proxima.scrollTop +
               '),(' + proxima.width + ',' + proxima.height + '))?');
}









]]></script>
</head>
<body onload="init()">
<div id="proxima" style="position: relative; border: 1px solid black; width: 1000px; height: 1000px; overflow:auto; font-size : 18px; font-family: monospace; line-height: 0px;"
     onmousedown="return mouseHandler('D',event)"
     onmouseup="return mouseHandler('U',event)"
     onclick="return mouseHandler('C',event)"
     onscroll="return scrollHandler(event)"
 ><div id="rendering"></div><div id="focus"></div><div id="newRendering" style='position: absolute; left: 400px; top: 0px;' ></div></div>



<!-- font positioning goes wrong: text is drawn at half-height ref at top of div box
<div style='position:absolute;left:20px;top:10px;width:463px;height:29px;font-family:"Times New Roman";font-size:19pt;background-color:rgb(120,120,120);'>B</div>
-->
<!-- weird rendering when line-height /= 0px
<div style='position: absolute; left:0px; top:0px;width:40px;height:40px;'>
<svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
<polygon points='1,1 40,1' style='fill:transparent; stroke:rgb(255,0,0);stroke-width:1'/>
<line x1='1' y1='1' x2='40' y2='' style='stroke:rgb(0,0,0);stroke-width:1'/>
</svg></div>
-->

<!--
<div style='position: absolute; left:0px; top:0px;width:17px;height:4px;'>
      <svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
       <polygon points='0,0 14,0' style='fill:transparent; stroke:rgb(255,0,0);stroke-width:1'/>
      </svg>
</div>
-->
<!-- strange rendering of poly's when height is less than 4
  <div style='position: absolute; left:0px; top:0px;width:15px;height:21px;'>
     <div style='position: absolute; left:-1px; top:-1px;width:17px;height:4px;'>
      <svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
       <polygon points='0,0 14,0' style='fill:transparent; stroke:rgb(255,0,0);stroke-width:1'/>
      </svg>
     </div>
   <div style='position: absolute; left:0px; top:1px;width:15px;height:19px;'>
     <div style='position: absolute; left:-1px; top:-1px;width:5px;height:21px;'>
      <svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
       <polygon points='0,0 0,18' style='fill:transparent; stroke:rgb(0,0,0);stroke-width:1'/>
      </svg>
     </div>
    <div style='position:absolute;left:1px;top:0px;width:13px;height:19px;'>
      <div style='position:absolute;left:0px;top:9px;width:13px;height:19px;font-family:"Times New Roman";font-size:12pt;color:rgb(0,0,0);'>zu</div>
    </div>
     <div style='position: absolute; left:13px; top:-1px;width:5px;height:21px;'>
      <svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
       <polygon points='0,0 0,18' style='fill:transparent; stroke:rgb(0,0,0);stroke-width:1'/>
      </svg>
     </div>
   </div>
    <div style='position: absolute; left:-1px; top:19px;width:17px;height:4px;'>
     <svg width='100%' height='100%' version='1.1' xmlns='http://www.w3.org/2000/svg'>
      <polygon points='0,0 14,0' style='fill:transparent; stroke:rgb(0,0,0);stroke-width:1'/>
     </svg>
    </div>
  </div>

-->
 <!-- relative to parent. Important: parent needs style = 'position: relative' -->
<div id="status" style="border: 1px solid black; height: 22px; width: 800px; font-size : 18px; font-family: monospace; line-height: 20px;" ></div>

<!-- <button onclick="loadXMLDoc('SpecialRefresh?')">Refresh</button>
<button onclick="loadXMLDoc('SpecialClear?')">Clear</button> -->
<div id="debugMessage"></div>
<div id="test"><div id="A"><div id="A.A"></div><div id="A.B"><div id="A.B.A"></div><div id="A.B.B"></div><div id="A.B.C"></div></div></div><div id="B"></div><div id="C"></div></div>
<div id="path"><div childNr="0"></div><div childNr="1"></div><div childNr="2"></div></div>
</body></html>













